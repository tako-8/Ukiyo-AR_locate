<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>GeoAR.js demo</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
  </head>

  <body>
    <a-scene
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
      renderer='antialias: true; alpha: true'
      >

      <!-- <a-text
        value="This content will always face you."
        look-at="[gps-camera]"
        scale="120 120 120"
      ></a-text> -->
      <a-camera gps-new-camera></a-camera>
      
      <!-- <a-entity gps-new-entity-place="latitude: 35.6319710; longitude: 140.1072964;">
        <a-box material="color: blue" position="0 0 0"/>
        <a-box material="color: yellow" position="0 0 1"/>
      </a-entity> -->
    </a-scene>

    <script>
//       window.onload = () => {
//     let testEntityAdded = false;

//     const el = document.querySelector("[gps-new-camera]");

//     el.addEventListener("gps-camera-update-position", e => {
//         if(!testEntityAdded) {
//             alert(`Got first GPS position: lon ${e.detail.position.longitude} lat ${e.detail.position.latitude}`);
//             // Add a box to the north of the initial GPS position
//             const entity = document.createElement("a-box");
//             entity.setAttribute("scale", {
//                 x: 20, 
//                 y: 20,
//                 z: 20
//             });
//             entity.setAttribute('material', { color: 'red' } );
//             entity.setAttribute('gps-new-entity-place', {
//                 latitude: e.detail.position.latitude + 0.001,
//                 longitude: e.detail.position.longitude
//             });
//             document.querySelector("a-scene").appendChild(entity);
//         }
//         testEntityAdded = true;
//     });
// };
window.onload = () => {
    let testEntityAdded = false;

    const el = document.querySelector("[gps-new-camera]");

    // デバイスの方向を取得する関数
    function getDeviceHeading() {
        return new Promise((resolve, reject) => {
            if ('DeviceOrientationEvent' in window) {
                const handler = (event) => {
                    window.removeEventListener('deviceorientation', handler);
                    resolve(event.alpha);
                };
                window.addEventListener('deviceorientation', handler);
            } else {
                reject(new Error('DeviceOrientationEvent not supported on this device'));
            }
        });
    }

    el.addEventListener("gps-camera-update-position", async (e) => {
        if (!testEntityAdded) {
            // デバイスの方向を取得
            try {
                const deviceHeading = await getDeviceHeading();
                alert(`Device Heading: ${deviceHeading}`);

                // Add a box to the north of the initial GPS position
                const entity = document.createElement("a-box");
                entity.setAttribute("scale", {
                    x: 20,
                    y: 20,
                    z: 20
                });
                entity.setAttribute('material', { color: 'red' });
                
                // ここで北の方向に位置を設定
                const newPosition = {
                    latitude: e.detail.position.latitude + 0.001,
                    longitude: e.detail.position.longitude
                };
                document.querySelector("a-scene").appendChild(entity);
                entity.setAttribute('gps-new-entity-place', newPosition);
            } catch (error) {
                console.error('Error getting device heading:', error);
            }
        }
        testEntityAdded = true;
    });
};
  </script>
  </body>
</html>
